 workflow:
    - location: ../data/
    
    inputs:
        CH_R1 : SequenceReadArchivePaired #<- Name of input is used as name prefix. Every class can use its scheme for input name
        CH_R2 : SequenceReadArchivePaired
        PR_R1 : SequenceReadArchivePaired
        PR_R2 : SequenceReadArchivePaired
        PlasmoDB-29_Pfalciparum3D7_Genome : RefGenome #<- Name of input is used as name parameter
        PlasmoDB-29_Pfalciparum3D7 : GenFeatureFormat #<- Name of input is used as name parameter
        blacklist: file:://path/to/CentromereTelomereRegions.bed

    steps:
        qc:
            method: fastqc
            inputs:
                fastq: CH_R1 +  + CH_R2 + PR_R1 + PR_R2
                outdir: "."
        
        process:
            repeat:
                for: 
                    iter1: [ CH_R1, CH_R2]
                    iter2: [ PR_R1, PR_R2 ]
                mapto: [ read1, read2 ]
                do:
                    scatter:
                        use: [ read_1, read_2 ]
                        method: dotproduct
                        provide: [ one, two ]
                    
                        #The step name has to be unique in scope thus a function/class/method is specified.
                        #If not specified, then step name is used as class name
                        
                        geno-align:
                            method: align 
                            inputs:
                                #implicit input one and two by scatter
                                #Synthesizing outputfile name can be encapsulated as convention in the "align" implementation 
                                # align implementation take RefGenome as input
                                reference: referrence_29
        
                        # convert to bam
                        convert:
                            method: samtools-view
                            inputs:
                                input: geno-align/aligned-file
                                output-basename: one.basename #<- The method adds ".bam"
                                #Everyhting else the method class can synthesize
        
                        # sort and compress
                        sort:
                            method: samtools-sort
                            inputs:
                                input: convert/output
                                output-basename: one.basename
        
                        # index bam    
                        index:
                            method: samtools-index
                            inputs:
                                input: sort/sorted
        
                        # Remove duplicate reads
                        dedup:
                            method: picar-markduplicates
                            inputs:
                                inputFileName_markDups: sort/sorted
                                outputFileName_markDups: one.basename
                                metricsFile: one.basename
        
                        # index duplicates
                        index-dedup:
                            method: samtools-index
                            inoputs:
                                input: dedup/markDups_output
        
                        insert-metrics:
                            method: picard-CollectInsertSizeMetrics
                            inputs:
                                input: dedup/markDups_output
                                output: one.basename
                                histogram_file: one.basename
        
                        coverage:
                            method: bedtools-genomecov
                            inputs:
                                input: 
                                    source: dedup/markDups_output
                                    format: "http://edamontology.org/format_2572" # <- Forces CWL directives during translation 
                                genomecoverageout: one.basename
         
                         # Summarize genomecov output
                         summarize-genomecov:
                            method: awk
                            inputs:
                                infile: coverage/genomecoverage
                                program:
                                    type: string
                                    value: '{total += $3; count +=1; sumsq += $3*$3}; END {print "mean cov is", total / count, ". Var of cov is", (sumsq - total^2/count)/(count-1)}'
                                outputFileName: one.basename
        
                        # bedtools intersect genic
                        intersect-genic:
                            method: bedtools-intersect
                            inputs:
                                inputA:
                                    source: dedup/markDups_output
                                    format: "http://edamontology.org/format_2572" # <- Forces CWL directives during translation 
                                inputB: gff
                                intersectout: one.basename
        
                         # Inspect coverage of genic intersection
                         coverage-genic:
                            method: bedtools-genomecov
                            inputs:
                                input:
                                    source: intersect-genic/intersect
                                    format: "http://edamontology.org/format_2572" # <- Forces CWL directives during translation 
                                genomecoverageout: one.basename
                
        
                        # Summarize coverage output
                        summarize-genic-genomecov:
                            method: awk
                            inputs:
                                inFile: coverage-genic/genomecoverage
                                program:
                                    type: string
                                    value: '{total += $3; count +=1}; END {print "total of all reads at genic bases", total, ", mean cov is", total / 13979861}'
                
                                outputFileName: one.basename
                
                        # Looking at bams in IGV is memory-hungry, and could be replaced by using tdf-format
                        # coverage files. 3D7-merge-B3_S1-C5_S2.bam done at command line.
                        # Default window size is 25bp
        
                        igvtools:
                            method: igvtools-count
                            inputs:
                                inputFile: dedup/markDups_output
                                outputFileName: one.basename
                                gnome: reference_29
    
        # Parent Merge
        merge-parents:
            method: samtools-merge
            inputs:
                input: process[iter2]/dedup/markDups_output
                outputFile: 3D7-merge-B2_S1-F4_S4.bam

        # GRIDSS
        scatter:
            use: [ process[iter2]/dedup/markDups_output ]
            provide: [ main-input ]
            
            gridss:
                cwl-tool: gridss-callvariants
                inputs:
                    input: main-input #<- Implicit type promotion form single item to array
                    input2: merge-parents/merge
                    input-label:  main-input.basename #<- Implicit type promotion form single item to array
                    input-label2: merge-parents/merge.basename #<- Implicit type promotion form single item to array
                    output: main-input.basename #<- The method adds "'.gridss.assembly.vcf"
                    assembly: main-input.basename #<- The method adds ".gridss.assembly.bam"
                    reference_sequence: reference_29
                    blacklist: blacklist
                
            




            
    

        
        
        
        
        
